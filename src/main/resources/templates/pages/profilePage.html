<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://thymeleaf.org">

<head th:replace="~{fragments/head :: head(title='Gardener\'s Grove - My Profile')}"></head>

<body>
    <div th:replace="~{fragments/header :: header}"></div>

    <main class="centred">
        <div class="basic">
            <h1>My Profile</h1>
            <div class="profile-picture-wrapper">
                <img class="profile-picture" id="profileImage" th:src="${picturePath}" alt="Profile Picture">
            </div>

            <form th:action="@{/profile}" th:object="${profilePictureForm}" method="post" enctype="multipart/form-data">
                <label id="pictureFileLabel" class="file-upload-label" th:for="pictureFile">Edit Profile Picture</label>
                <input type="file" th:field="*{pictureFile}" onchange="validateImage(this)" accept="image/png, image/jpeg, image/svg+xml">
                <button type="button" id="cancelButton" class="cancel" style="display: none;" th:attr="onclick='cancelUpload(\'' + ${picturePath} + '\')'">Undo</button>
                <button type="submit" id="submitButton" style="display: none;">Save Profile Picture</button>
                <span id="clientSideErrorMessage" class="error"></span>
            </form>
            <p th:text="${fName} + (${lName} ? ' ' + ${lName} : '')"></p>
            <br>
            <p th:text="'Email: ' + ${email}"></p>
            <br>
            <p th:if="${dob != null}" th:text="'Date of birth: ' + ${dob}"></p>
            <a th:href="@{editProfile}">Edit profile</a>
            <form th:action="@{logout}" method="post">
                <button class="cancel" type="submit">Log Out</button>
            </form>
        </div>
    </main>
    <script>
        function validateImage(input) {
            if (!(input.files && input.files[0])) {
                return;
            }
            const file = input.files[0];
            const validTypes = ["image/png", "image/jpeg", "image/svg+xml"];
            const maxFileSize = 10 * 1024 * 1024;

            if (!validTypes.includes(file.type) && file.size > maxFileSize) {
                input.value = '';
                document.getElementById('clientSideErrorMessage').textContent = "Image must be of type png, jpg or svg, and less than 10MB";
                return;
            }
            if (!validTypes.includes(file.type)) {
                input.value = '';
                document.getElementById('clientSideErrorMessage').textContent = "Image must be of type png, jpg or svg";
                return;
            }
            if (file.size > maxFileSize) {
                input.value = '';
                document.getElementById('clientSideErrorMessage').textContent = "Image must be less than 10MB";
                return;
            }

            const fileReader = new FileReader();
            fileReader.onload = function (e) {
                document.getElementById('profileImage').src = e.target.result;
            }
            fileReader.readAsDataURL(input.files[0]);

            document.getElementById('pictureFileLabel').style.display = 'none';
            document.getElementById('cancelButton').style.display = 'inline-block';
            document.getElementById('submitButton').style.display = 'inline-block';
            document.getElementById('clientSideErrorMessage').textContent = "";
        }

        function cancelUpload(initialPicturePath) {
            document.getElementById('pictureFile').value = '';
            document.getElementById('profileImage').src = initialPicturePath;
            document.getElementById('pictureFileLabel').style.display = 'inline-block';
            document.getElementById('cancelButton').style.display = 'none';
            document.getElementById('submitButton').style.display = 'none';
        }
    </script>
</body>
</html>